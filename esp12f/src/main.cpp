#include "Org_01.h"
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Arduino.h>
#include <DHT.h>
#include <SoftwareSerial.h>
#include <TinyGPSPlus.h>
#include <Wire.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C
#define OLED_SDA 2
#define OLED_SCL 14

// GPS Pins (D6 = GPIO12, D7 = GPIO13)
#define GPS_RX 12
#define GPS_TX 13

// DHT Sensor Pin (GPIO05 = D1)
#define DHTPIN 5
#define DHTTYPE DHT11

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
SoftwareSerial gpsSerial(GPS_RX, GPS_TX);
TinyGPSPlus gps;
DHT dht(DHTPIN, DHTTYPE);

// UI Variables
String ui_time = "00:00:00";
String ui_temp = "--";
String ui_hum = "--";
String ui_lat = "-0.00";
String ui_lon = "-0.00";
bool hasGPSFix = false;

// UI Bitmaps
static const unsigned char PROGMEM image_weather_humidity_bits[] = {
    0x04, 0x00, 0x04, 0x00, 0x0c, 0x00, 0x0e, 0x00, 0x1e, 0x00, 0x1f,
    0x00, 0x3f, 0x80, 0x3f, 0x80, 0x7e, 0xc0, 0x7f, 0x40, 0xff, 0x60,
    0xff, 0xe0, 0x7f, 0xc0, 0x7f, 0xc0, 0x3f, 0x80, 0x0f, 0x00};
static const unsigned char PROGMEM image_weather_temperature_bits[] = {
    0x1c, 0x00, 0x22, 0x02, 0x2b, 0x05, 0x2a, 0x02, 0x2b, 0x38, 0x2a,
    0x60, 0x2b, 0x40, 0x2a, 0x40, 0x2a, 0x60, 0x49, 0x38, 0x9c, 0x80,
    0xae, 0x80, 0xbe, 0x80, 0x9c, 0x80, 0x41, 0x00, 0x3e, 0x00};
static const unsigned char PROGMEM image_passport_left_bits[] = {
    0x3c, 0x40, 0x98, 0xa4, 0xa4, 0x98, 0x80, 0x80, 0xa0, 0x90, 0x88, 0xa4,
    0x90, 0x88, 0xa4, 0x90, 0x88, 0xa4, 0x90, 0x88, 0xa4, 0x90, 0x88, 0xa4,
    0x90, 0x88, 0x84, 0x80, 0x40, 0x60, 0x70, 0x78, 0x7c, 0x5c, 0x4c, 0x4c,
    0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c};
static const unsigned char PROGMEM image_passport_left__copy__bits[] = {
    0xf0, 0x08, 0x64, 0x94, 0x94, 0x64, 0x04, 0x04, 0x14, 0x24, 0x44, 0x94,
    0x24, 0x44, 0x94, 0x24, 0x44, 0x94, 0x24, 0x44, 0x94, 0x24, 0x44, 0x94,
    0x24, 0x44, 0x84, 0x04, 0x08, 0x18, 0x38, 0x78, 0xf8, 0xe8, 0xc8, 0xc8,
    0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8};
static const unsigned char PROGMEM image_clock_alarm_bits[] = {
    0x79, 0x3c, 0xb3, 0x9a, 0xed, 0x6e, 0xd0, 0x16, 0xa0, 0x0a, 0x41,
    0x04, 0x41, 0x04, 0x81, 0x02, 0xc1, 0x06, 0x82, 0x02, 0x44, 0x04,
    0x48, 0x04, 0x20, 0x08, 0x10, 0x10, 0x2d, 0x68, 0x43, 0x84};
static const unsigned char PROGMEM image_earth_bits[] = {
    0x07, 0xc0, 0x1e, 0x70, 0x27, 0xf8, 0x61, 0xe4, 0x43, 0xe4, 0x87,
    0xca, 0x9f, 0xf6, 0xdf, 0x82, 0xdf, 0x82, 0xe3, 0xc2, 0x61, 0xf4,
    0x70, 0xf4, 0x31, 0xf8, 0x1b, 0xf0, 0x07, 0xc0, 0x00, 0x00};
static const unsigned char PROGMEM image_passport_left__copy___copy__bits[] = {
    0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c, 0x4c,
    0x5c, 0x7c, 0x78, 0x70, 0x60, 0x40, 0x80, 0x84, 0x88, 0x90, 0xa4, 0x88,
    0x90, 0xa4, 0x88, 0x90, 0xa4, 0x88, 0x90, 0xa4, 0x88, 0x90, 0xa4, 0x88,
    0x90, 0xa0, 0x80, 0x80, 0x98, 0xa4, 0xa4, 0x98, 0x40, 0x3c};
static const unsigned char PROGMEM image_weather_sun_bits[] = {
    0x01, 0x00, 0x21, 0x08, 0x10, 0x10, 0x03, 0x80, 0x8c, 0x62, 0x48,
    0x24, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x48, 0x24, 0x8c, 0x62,
    0x03, 0x80, 0x10, 0x10, 0x21, 0x08, 0x01, 0x00, 0x00, 0x00};
static const unsigned char PROGMEM image_weather_cloud_rain_bits[] = {
    0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x08, 0x20, 0x00, 0x10, 0x10, 0x00,
    0x30, 0x08, 0x00, 0x40, 0x0e, 0x00, 0x80, 0x01, 0x00, 0x80, 0x00, 0x80,
    0x40, 0x00, 0x80, 0x3f, 0xff, 0x00, 0x01, 0x10, 0x00, 0x22, 0x22, 0x00,
    0x44, 0x84, 0x00, 0x91, 0x28, 0x00, 0x22, 0x40, 0x00, 0x00, 0x80, 0x00};
static const unsigned char PROGMEM image_weather_cloud_lightning_bolt_bits[] = {
    0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x08, 0x20, 0x00, 0x10, 0x10, 0x00,
    0x30, 0x08, 0x00, 0x40, 0x0e, 0x00, 0x80, 0x81, 0x00, 0x81, 0x00, 0x80,
    0x43, 0x00, 0x80, 0x26, 0x3f, 0x00, 0x0f, 0x80, 0x00, 0x01, 0x80, 0x00,
    0x03, 0x00, 0x00, 0x02, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00};
static const unsigned char PROGMEM image_satellite_dish_bits[] = {
    0x00, 0x00, 0x00, 0x78, 0x30, 0x04, 0x2c, 0x32, 0x63, 0x0a, 0xa8,
    0xea, 0x92, 0xa2, 0x90, 0xe0, 0x89, 0x10, 0x8a, 0x48, 0x44, 0x08,
    0x43, 0x24, 0x20, 0xc4, 0x30, 0x3c, 0x0c, 0x10, 0x03, 0xe0};
static const unsigned char PROGMEM image_weather_cloud_sunny_bits[] = {
    0x00, 0x20, 0x00, 0x02, 0x02, 0x00, 0x00, 0x70, 0x00, 0x01, 0x8c, 0x00,
    0x09, 0x04, 0x80, 0x02, 0x02, 0x00, 0x02, 0x02, 0x00, 0x07, 0x82, 0x00,
    0x08, 0x44, 0x80, 0x10, 0x2c, 0x00, 0x30, 0x30, 0x00, 0x60, 0x1e, 0x00,
    0x80, 0x03, 0x00, 0x80, 0x01, 0x00, 0x80, 0x01, 0x00, 0x7f, 0xfe, 0x00};
static const unsigned char PROGMEM image_weather_wind_bits[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x03, 0x88, 0x04, 0x44, 0x04,
    0x44, 0x00, 0x44, 0x00, 0x88, 0xff, 0x32, 0x00, 0x00, 0xad, 0x82,
    0x00, 0x60, 0x00, 0x10, 0x00, 0x10, 0x01, 0x20, 0x00, 0xc0};
static const unsigned char PROGMEM image_Bluetooth_Idle_bits[] = {
    0x20, 0xb0, 0x68, 0x30, 0x30, 0x68, 0xb0, 0x20};
static const unsigned char PROGMEM image_BLE_beacon_bits[] = {
    0x44, 0x92, 0xaa, 0x92, 0x54, 0x10, 0x10, 0x7c};
static const unsigned char PROGMEM
    image_passport_left__copy___copy___copy__bits[] = {
        0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8, 0xc8,
        0xe8, 0xf8, 0x78, 0x38, 0x18, 0x08, 0x04, 0x84, 0x44, 0x24, 0x94, 0x44,
        0x24, 0x94, 0x44, 0x24, 0x94, 0x44, 0x24, 0x94, 0x44, 0x24, 0x94, 0x44,
        0x24, 0x14, 0x04, 0x04, 0x64, 0x94, 0x94, 0x64, 0x08, 0xf0};
static const unsigned char PROGMEM image_mouth_bits[] = {0x82, 0x82, 0x82, 0x44,
                                                         0x38};
static const unsigned char PROGMEM image_Battery_bits[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0xf0,0x10,0x08,0x32,0xa8,0x32,0xa8,0x10,0x08,0x0f,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

bool flashState = false;
bool eyeState = true; // true = open, false = closed
unsigned long lastBlink = 0;
unsigned long blinkInterval = 3000;

void draw(void) {
  display.clearDisplay();

  // weather_humidity
  display.drawBitmap(9, 45, image_weather_humidity_bits, 11, 16, 1);

  // weather_temperature
  display.drawBitmap(9, 24, image_weather_temperature_bits, 16, 16, 1);

  // passport_borders
  display.drawBitmap(0, 18, image_passport_left_bits, 6, 46, 1);
  display.drawBitmap(122, 18, image_passport_left__copy__bits, 6, 46, 1);
  display.drawBitmap(0, -29, image_passport_left__copy___copy__bits, 6, 46, 1);
  display.drawBitmap(122, -29, image_passport_left__copy___copy___copy__bits, 6,
                     46, 1);

  // Layer 7 (Separator line)
  display.drawLine(5, 18, 122, 18, 1);

  // GPS/System Indicators
  display.drawBitmap(65, 24, image_clock_alarm_bits, 15, 16, 1);

  if (hasGPSFix) {
    display.drawBitmap(65, 45, image_earth_bits, 15, 16, 1);
  } else {
    if (flashState) {
      display.drawBitmap(67, 44, image_satellite_dish_bits, 15, 16, 1);
    }
  }

  // Bluetooth Icons
  display.drawBitmap(115, 0, image_Bluetooth_Idle_bits, 5, 8, 1);
  display.drawBitmap(106, 0, image_BLE_beacon_bits, 7, 8, 1);
  // Battery
  display.drawBitmap(106, 5, image_Battery_bits, 16, 16, 1);

  // Dynamic Weather Icon based on Humidity (Example logic)
  int hum = ui_hum.toInt();
  if (hum > 70) {
    display.drawBitmap(8, 0, image_weather_cloud_rain_bits, 17, 16, 1);
  } else if (hum > 50) {
    display.drawBitmap(8, 0, image_weather_cloud_sunny_bits, 17, 16, 1);
  } else {
    display.drawBitmap(8, 0, image_weather_sun_bits, 15, 16, 1);
  }

  // Animated Face
  if (eyeState) {
    display.fillCircle(54, 6, 3, 1);
    display.fillCircle(76, 6, 3, 1);
  } else {
    display.drawLine(51, 6, 57, 6, 1);
    display.drawLine(73, 6, 79, 6, 1);
  }
  display.drawBitmap(62, 10, image_mouth_bits, 7, 5, 1);

  // Text Values
  display.setFont(&Org_01);
  display.setTextColor(1);
  display.setTextSize(2);
  display.setTextWrap(false);

  // Humidity Value
  display.setCursor(27, 56);
  display.print(ui_hum + "%");

  // Temperature Value
  display.setCursor(27, 35);
  display.print(ui_temp);

  // Bottom section data
  display.setTextSize(1);

  // GPS Time
  display.setCursor(84, 33);
  display.print(ui_time);

  // Latitude
  display.setCursor(84, 49);
  display.print(ui_lat);

  // Longitude
  display.setCursor(84, 59);
  display.print(ui_lon);

  display.display();
}

void setup() {
  Serial.begin(115200);
  gpsSerial.begin(9600);
  Wire.begin(OLED_SDA, OLED_SCL);
  dht.begin();

  if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
    Serial.println(F("SSD1306 allocation failed"));
    for (;;)
      ;
  }

  display.clearDisplay();
  display.display();

  Serial.println(F("System Initialized."));
}

unsigned long lastUpdate = 0;
unsigned long lastFlash = 0;

void loop() {
  // GPS Processing - CRITICAL: Must be as frequent as possible
  while (gpsSerial.available() > 0) {
    gps.encode(gpsSerial.read());
  }

  // Blinking Logic
  if (millis() - lastBlink > (eyeState ? blinkInterval : 150)) {
    lastBlink = millis();
    eyeState = !eyeState;
    if (eyeState)
      blinkInterval = random(2000, 6000); // Randomize next blink
    draw();
  }

  // Flashing logic (every 500ms)
  if (millis() - lastFlash > 500) {
    lastFlash = millis();
    flashState = !flashState;
    if (!hasGPSFix)
      draw(); // Redraw only if searching to see the flash
  }

  // Value Updates (every 1 second)
  if (millis() - lastUpdate > 1000) {
    lastUpdate = millis();

    // Read Sensors
    float h = dht.readHumidity();
    float t = dht.readTemperature();

    if (!isnan(h))
      ui_hum = String((int)h);
    if (!isnan(t))
      ui_temp = String((int)t);

    // Read GPS Time (Usually available before location fix)
    if (gps.time.isValid() && gps.time.age() < 2000) {
      char timeStr[10];
      sprintf(timeStr, "%02d:%02d:%02d", gps.time.hour(), gps.time.minute(),
              gps.time.second());
      ui_time = String(timeStr);
    } else {
      ui_time = "00:00:00";
    }

    // Read GPS Location
    hasGPSFix = gps.location.isValid() && gps.location.age() < 5000;
    if (hasGPSFix) {
      ui_lat = String(gps.location.lat(), 2);
      ui_lon = String(gps.location.lng(), 2);
    } else {
      ui_lat = "-0.00";
      ui_lon = "-0.00";
    }

    Serial.printf("Temp: %s, Hum: %s, Sat: %d, Fix: %s, Time: %s\n",
                  ui_temp.c_str(), ui_hum.c_str(), gps.satellites.value(),
                  hasGPSFix ? "YES" : "NO", ui_time.c_str());

    draw();
  }
}
